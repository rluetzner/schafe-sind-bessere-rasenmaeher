<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet type=text/css href="/css/readable.min.css?v=v1.1.0"><meta name=description content><link rel="shortcut icon" href=/images/favicon.ico type=image/x-icon><title>Schafe sind bessere Rasenmäher | Building a client-server application with Akka.NET</title></head><body><header><h1>Schafe sind bessere Rasenmäher</h1><p>...ist einfach so!</p><figure><a href=/><img width=100 height=100 src=/images/schaf-rund.webp alt></a></figure><nav data-style=classy><span><a href=/posts/>Stuff</a>
</span><span><a href=/tech/>Tech</a>
</span><span><a href=/mindfulness/>Mindfulness</a>
</span><span><a href=/stories/>Geschichten</a></span></nav></header><main><h1>Building a client-server application with Akka.NET</h1><i data-feather=calendar></i>
<time datetime=2023-11-07>7. Nov 2023</time><br><b>Tags: </b><i data-feather=tag></i>
<a class="btn btn-sm btn-outline-dark tag-btn" href=/tags/dotnet>dotnet</a>
<a class="btn btn-sm btn-outline-dark tag-btn" href=/tags/c>c#</a>
<a class="btn btn-sm btn-outline-dark tag-btn" href=/tags/akka>akka</a><br><b>Estimated reading time: </b>6 minutes<article><h2 id=why-im-doing-what-im-doing>Why I&rsquo;m doing what I&rsquo;m doing</h2><p>About a week ago or so, the QA guys at work asked me if I could help them out a bit. The test scenario required deploying a cluster of VMs running our product and putting some load on it. After a short outburst from my side (&ldquo;HOW THE HELL DO YOU NOT DOCUMENT THE WAY YOU TEST THINGS!?&rdquo;) we got talking about a cool <em>manager</em> like application where we would be able to coordinate multiple clients running different load generators.</p><p>Here&rsquo;s a rough sketch of the idea that we formed.</p><ul><li>We want to have a manager instance with a web UI, where we can register different client systems.<ul><li>Client systems include Linux and Windows, so we need to be able to compile the code for both OSs.</li></ul></li><li>We already have existing load generators, but we want remote executors to start them and relay log output from the console back to the manager instance.</li><li>The web UI should show if a client has encountered errors or failed entirely.</li></ul><p>Just recently I&rsquo;ve written some remote executor classes for another application, but those used an actual SSH connection to the remote servers instead. If we want to work with Windows and Linux, I&rsquo;d rather not use a &ldquo;hacky&rdquo; solution with SSH. Now, of course Windows has Remote-PowerShell, but I loathe it with a vengeance. I&rsquo;ve messed around with Remote-PowerShell both with Terraform and Vagrant and ultimately threw out all the code and installed an SSH server on Windows instead.</p><aside><p><p>The huge problem with Remote-PowerShell is that it requires a whole bunch of setting up first to trust remote clients. You&rsquo;ll need to open ports in the Windows firewall, create a certificate, add some trusted hosts&mldr;</p><p>It&rsquo;s quite possible that what I&rsquo;m saying is wrong, because I always found it way too complicated.</p><p>SSH in comparison is simple and elegant. The setup can easily be automated and once you&rsquo;ve added your trusted public key(s), you can get started right away.</p></p></aside><p>Because some of my colleagues had used <a href=https://getakka.net>Akka.NET</a> in the past, the framework came to mind readily. Akka is an implementation of the Actor Model, where Actors are independent processes (or rather C# <code>Task</code>s) that interact with each other via asynchronous messaging. It&rsquo;s well suited for concurrency, but the fact that I was more interested in was <a href=https://getakka.net/articles/concepts/location-transparency.html>location transparency</a>. In theory it should be easy to run an actor anywhere in the network and send it messages. Perfect!!!</p><blockquote><p>A word of warning: I&rsquo;m not gonna explain much about what Akka is. If you&rsquo;re curious, you should head over to <a href=https://getakka.net>https://getakka.net</a> and skim the landing page to get an idea.</p></blockquote><p>I had tinkered with it years before, but I couldn&rsquo;t have written even a simple snippet of code without looking at the docs.</p><p>Luckily the docs at <a href=https://getakka.net>https://getakka.net</a> are pretty good and after having read the &ldquo;Getting started&rdquo; articles I felt well prepared to write me some remote execution Actors, unit test them, message them in different patterns and coordinate them&mldr;<strong>locally</strong>!!!</p><h2 id=getting-remoting-to-work>Getting remoting to work</h2><p>Of course it&rsquo;s to be expected that the &ldquo;Getting started&rdquo; section of the docs at <a href=https://getakka.net>https://getakka.net</a> wouldn&rsquo;t give me all the answers, so I delved into &ldquo;Clustering&rdquo;, &ldquo;Akka I/O&rdquo; and finally &ldquo;Remoting&rdquo;. Even though the <a href=https://getakka.net/articles/remoting/index.html>Remoting docs</a> sent me back to &ldquo;Akka I/O&rdquo;, I felt that the setup described there was overly complicated and not what I was looking for.</p><p>Instead, I found a suitable starting point for a client-server app at <a href=https://getakka.net/articles/remoting/deployment.html>Remotely Deploying Actors</a>. The article shows how to connect a <code>HelloActor</code> to an <code>EchoActor</code>, albeit between two processes running on the same machine. The setup is using TCP though, so it should be easy to move one of the processes onto another machine.</p><p>The crux is that you need to know how to setup your <em>Akka configuration</em>, e.g.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>akka {
</span></span><span style=display:flex><span>    actor.provider = remote
</span></span><span style=display:flex><span>    remote {
</span></span><span style=display:flex><span>        dot-netty.tcp {
</span></span><span style=display:flex><span>            port = 8080
</span></span><span style=display:flex><span>            hostname = localhost
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>You&rsquo;ll need to know exactly what to put into this config for either the server or client. The example above is for a server, here&rsquo;s what the client config might look like.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>akka {
</span></span><span style=display:flex><span>    actor{
</span></span><span style=display:flex><span>        provider = remote
</span></span><span style=display:flex><span>        deployment {
</span></span><span style=display:flex><span>            /remoteecho {
</span></span><span style=display:flex><span>                remote = &#34;akka.tcp://DeployTarget@localhost:8080&#34;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    remote {
</span></span><span style=display:flex><span>        dot-netty.tcp {
</span></span><span style=display:flex><span>            port = 0
</span></span><span style=display:flex><span>            hostname = localhost
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><aside><p>I&rsquo;m not going to copy over every piece of code from the <a href=https://getakka.net/articles/remoting/deployment.html>Remotely Deploying Actors article</a>, so if you&rsquo;re wondering where this config goes, head on over to the article or scroll down to find the link to a Git repo with my finished prototype.</p></aside><p>At this point I started messing around with the <code>localhost</code> and <code>8080</code> values. There&rsquo;s not much else to configure, so that should suffice, right?</p><p>So obviously, you&rsquo;ll need to change this part in the client config</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>remote = &#34;akka.tcp://DeployTarget@localhost:8080&#34;
</span></span></code></pre></div><p>into something like</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>remote = &#34;akka.tcp://DeployTarget@&lt;my-server-name-or-ip&gt;:&lt;remote-port&gt;&#34;
</span></span></code></pre></div><p>But that wasn&rsquo;t enough and it took me another hour or so to figure out why.</p><p>You also <strong>must</strong> make sure that the <code>hostname</code> in the <em>server</em> config matches the hostname that the client expects:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>remote {
</span></span><span style=display:flex><span>    dot-netty.tcp {
</span></span><span style=display:flex><span>        port = &lt;remote-port&gt;
</span></span><span style=display:flex><span>        hostname = &lt;my-server-name-or-ip&gt;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>That should get the example working over an actual network connection. For convenience I made the <code>hostname</code> and <code>port</code> configurable and read them from the starting arguments.</p><h2 id=unwrangling-my-brain>Unwrangling my brain</h2><p>At this point I had a bit of trouble understanding what happened where. I could see that I had connected a <code>HelloActor</code> to an <code>EchoActor</code>, but I couldn&rsquo;t really tell which process was doing what.</p><p>So I experimented a bit with inverting the roles, i.e. I instantiated a remote <code>HelloActor</code> that sent messages to my <em>client</em> <code>EchoActor</code>. Using <code>Environment.GetEnvironmentVariable("HOSTNAME")</code> I quickly figured out where each Actor was located and to confirm my theory I spun up another instance.</p><p>At this point I noticed that even though I had understood where my Actors were and from where they were instantiated, I hadn&rsquo;t actually built a client-server app yet. At least not in the sense I was thinking of.</p><p>What I wanted to do was have a <code>ControllerActor</code> running on my <em>server</em> and register remote <code>ClientActors</code> with it. So the last piece of the puzzle was to figure out how to instantiate a single <code>ControllerActor</code> on my <em>server</em> and get a reference to the Actor from a remote <em>client</em>, so I could send messages to it.</p><p>And here it is:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>string</span> remoteHost = <span style=color:#e6db74>&#34;&lt;my-server-name-or-ip&gt;&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>string</span> port = <span style=color:#e6db74>&#34;&lt;remote-port&gt;&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>string</span> actorPath = <span style=color:#e6db74>$&#34;akka.tcp://DeployTarget@{remoteHost}:{remotePort}/user/controller&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ActorSelection selection = system.ActorSelection(actorPath);
</span></span><span style=display:flex><span>Task getReferenceTask = selection.ResolveOne(TimeSpan.FromSeconds(<span style=color:#ae81ff>30</span>));
</span></span><span style=display:flex><span>IActorRef actor = getReferenceTask.Result;
</span></span></code></pre></div><p>Registering a <code>ClientActor</code> was then pretty easy. All I needed to do was instantiate a <code>ClientActor</code> with my <em>remote</em> <code>ActorSystem</code> and hand over the reference to the <code>ControllerActor</code>. From there on out, I could work with <code>Tell()</code> and start adding commands.</p><h2 id=the-finished-prototype>The finished prototype</h2><p><figure><img src=client-server-akka.webp alt="A screenshot of tmux running with three panes. One pane shows the server printing the output of remote executed bash commands, the other panes show the clients."><figcaption>A screenshot of tmux running with three panes. One pane shows the server printing the output of remote executed bash commands, the other panes show the clients.</figcaption></figure></p><p>I put my code up on <a href=https://codeberg.org/rluetzner/akka-remoting-test>https://codeberg.org/rluetzner/akka-remoting-test</a> . It is not the prettiest code and if you&rsquo;re an Akka.NET expert you&rsquo;ll likely run away screaming or burst into tears laughing, but it gets the job done.</p><p><em>This</em> is the article and <em>that</em> is the code I&rsquo;ve been looking for, for the last two days. 😅</p></article><a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/><img alt="Creative Commons License" style=border-width:0 src=https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png></a><br><span xmlns:dct=http://purl.org/dc/terms/ href=http://purl.org/dc/dcmitype/Text property="dct:title" rel=dct:type><i>Building a client-server application with Akka.NET</i></span> written by <a xmlns:cc=http://creativecommons.org/ns# href=/tech/building-a-client-server-app-with-akka-net/ property="cc:attributionName" rel=cc:attributionURL>Robert Lützner</a> is licensed under <a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/>Creative Commons Attribution - NonCommercial - ShareAlike 4.0 International license</a>.</main><footer><p>© 2024 Robert Lützner</p><a href=https://rollenspiel.social/@mforester rel=me target=blank>Mastodon</a> | <a href=https://codeberg.org/rluetzner>Codeberg</a> | <a href=/imprint/>Contact Me</a> | <a href=/rss>RSS Feeds</a> | <a href=/imprint>Imprint</a></p></footer></body></html>