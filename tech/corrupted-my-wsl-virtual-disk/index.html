<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet type=text/css href="/css/readable.min.css?v=v1.1.0"><meta name=description content><link rel="shortcut icon" href=/images/favicon.ico type=image/x-icon><title>Schafe sind bessere RasenmÃ¤her | How I accidentally corrupted my WSL virtual disk and what I learned from it</title></head><body><header><h1>Schafe sind bessere RasenmÃ¤her</h1><p>...ist einfach so!</p><figure><a href=/><img width=100 height=100 src=/images/schaf-rund.webp alt></a></figure><nav data-style=classy><span><a href=/posts/>Stuff</a>
</span><span><a href=/tech/>Tech</a>
</span><span><a href=/mindfulness/>Mindfulness</a>
</span><span><a href=/stories/>Geschichten</a>
</span><span><a href=/imprint/>Imprint</a></span></nav></header><main><h1>How I accidentally corrupted my WSL virtual disk and what I learned from it</h1><i data-feather=calendar></i>
<time datetime=2023-01-12>12. Jan 2023</time>
<i data-feather=tag></i>
<a class="btn btn-sm btn-outline-dark tag-btn" href=/tags/wsl>WSL</a>
<a class="btn btn-sm btn-outline-dark tag-btn" href=/tags/linux>Linux</a>
<a class="btn btn-sm btn-outline-dark tag-btn" href=/tags/windows>Windows</a><article><p>I love WSL. I mainly develop for Linux systems at work, but for company reasons am forced to use a Windows machine. WSL is the next best thing and I&rsquo;ve been spending almost my entire time the last few years inside this sweet Linux environment.</p><p>A few days ago however, I managed to almost destroy my WSL instance. It took me a while to figure out what exactly happened, but here it goes.</p><h2 id=the-prose-story>The prose story</h2><p>As the new year started, I took some time to clean up my system. I noticed that my drive was running pretty low on space and ran <strong>TreeSize</strong> to analyze which files were the cause. I found an old development VM that used up more than 100GB, which I finally deleted after not booting it up for more than two years.</p><p>I should have been satisfied with this huge freed up space, but I kept digging. I found out that my WSL instance takes up about 40GB, which I found weird, because there aren&rsquo;t really that many big files in there. I dug through my notes and found the following commands.</p><aside><p><p><strong>WARNING!!!</strong></p><p><strong>Although I&rsquo;ve run these commands successfully in the past, this is part of what sent me on my way of destruction.</strong></p></p></aside><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#75715e># As Admin</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Requires the Hyper-V PowerShell Module to be installed.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Also requires Hyper-V services to be installed.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># wsl and Docker Desktop must first be stopped:</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#   wsl --shutdown</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#   Stop Docker manually by clicking the icon.</span>
</span></span><span style=display:flex><span>Optimize-VHD -Path $env:LOCALAPPDATA\Packages\46932SUSE.openSUSETumbleweed_022rs5jcyhyac\LocalState\ext4.vhdx -Mode Full
</span></span></code></pre></div><p>After running this command, I was unable to start WSL again. It failed with an error message that sounded like <em>used by another process</em>, i.e. something on my system was blocking access to the file.</p><p>I ran <strong>Unlocker</strong>, but couldn&rsquo;t find the cause. I did some internet research and found a comment that prompted me to check the Windows Disk Management dialog. There should be a virtual disk that I was supposed to unmount.</p><p><figure><img src=windows-disk-management.webp alt="A screenshot of the Windows Disk Managment dialog."><figcaption>A screenshot of the Windows Disk Managment dialog.</figcaption></figure></p><p>For whatever reason, in between reading this post and opening up the dialog, I forgot all about the virtual disk and especially why it would be there in the first place. So when I opened up the dialog, I was confronted with a message box.</p><p>I tried to reproduce the issue, but I couldn&rsquo;t manage to force it again. So all I can do is describe the contents of the message box to the best of my knowledge.</p><p>If you&rsquo;ve worked with Windows and ever added a new disk to a system, you&rsquo;ve probably seen this prompt before.</p><p><em>We found a new disk that&rsquo;s not initialized. Would you like to initialize it?</em></p><p>I clicked <em>yes</em> and all of a sudden I had a shiny new <em>virtual disk drive</em>. Only&mldr;I got the sinking feeling that I did something horribly, stupidly wrong. ðŸ˜¨</p><p>Now my WSL still didn&rsquo;t want to start, but the error message changed ever so slightly.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>A connection attempt failed because the connected party did not properly respond after a period of time, or established connection failed because connected host has failed to respond.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[process exited with code 4294967295]
</span></span></code></pre></div><p>Okay, now what? I spent a lot of time looking up parts of this message. Interestingly enough the error code<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> yielded some results, although I had to dig deep through a bunch of solutions that simply wouldn&rsquo;t work for me.</p><p>I finally found <a href=https://github.com/microsoft/WSL/issues/5092#issuecomment-1332427373>this answer</a> &ndash; the steps of which I&rsquo;m going to describe shortly &ndash; and now everything clicked.</p><h2 id=what-happened>What happened</h2><p>What I didn&rsquo;t know before is that the contents of a WSL instance are saved in a Hyper-V virtual disk. I mean I could have and probably should have known (going by the <code>.vhdx</code> file ending), but I didn&rsquo;t put two and two together. ðŸ˜…</p><p>What Optimize-VHD does is</p><ul><li>mount the disk locally and</li><li>run some optimizations, defragmentation, whatever on it.</li></ul><p>The command should end up unmounting the virtual disk when it&rsquo;s finished, but it seems like I&rsquo;m not the only one for whom that didn&rsquo;t happen.</p><p>When I opened up the Windows Disk Management dialog, I was prompted to initialize the disk, because Windows wasn&rsquo;t able to read the partition table written by Linux.</p><p>Of course I then trashed the existing partition table with the Windows MBR and now Linux (or rather WSL) was no longer able to read it.</p><h2 id=how-i-fixed-it>How I fixed it</h2><p>Again, it&rsquo;s all thanks to <a href=https://github.com/microsoft/WSL/issues/5092#issuecomment-1332427373>this answer on GitHub</a>. ðŸš€ðŸŽ‰</p><p>I never would have managed to figure this out on my own.</p><p>First, I installed a new WSL instance &ndash; Ubuntu &ndash; from the Windows Store. I chose Ubuntu for two reasons.</p><ol><li>I could not install openSUSE Tumbleweed again. I would have had to delete my existing installation, which I wasn&rsquo;t yet willing to give up.</li><li>The commands and packages mentioned in the comment I found on GitHub were meant for a Debian/Ubuntu system and I didn&rsquo;t want the hassle of finding their equivalents on an openSUSE system.</li></ol><p>I started up the Ubuntu instance and ran the following commands. These are not exactly the commands you will find in the GitHub comment, because some of those have since been deprecated.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt update
</span></span><span style=display:flex><span>sudo apt-get install libguestfs-tools linux-image-generic
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># List all partitions from the virtual disk.</span>
</span></span><span style=display:flex><span>sudo virt-filesystems --all -a /mnt/c/Users/robertl/AppData/Local/Packages/46932SUSE.openSUSETumbleweed_022rs5jcyhyac/LocalState/ext4.vhdx
</span></span><span style=display:flex><span><span style=color:#75715e># In my case this listed</span>
</span></span><span style=display:flex><span><span style=color:#75715e># /dev/sda</span>
</span></span><span style=display:flex><span><span style=color:#75715e># /dev/sda1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo virt-rescue -a /mnt/c/Users/roberts/AppData/Local/Packages/46932SUSE.openSUSETumbleweed_022rs5jcyhyac/LocalState/ext4.vhdx
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># You&#39;ve now entered rescue mode for virtual disks.</span>
</span></span><span style=display:flex><span>e2fsck -y /dev/sda
</span></span></code></pre></div><p>After this is finished, I was able to start my openSUSE Tumbleweed instance again. No data was lost.</p><h2 id=what-ive-learned>What I&rsquo;ve learned</h2><p>I already mentioned that I&rsquo;ve learned a bit about how WSL is implemented, i.e. that the data is stored in a Hyper-V virtual disk file hidden away in <code>%LOCALAPPDATA%</code>.</p><p>I wasn&rsquo;t really worried about losing any vital data. I regularly push the code I write, so no work progress would have been lost.</p><p>I usually put my scripts into versioning as well, but I had a few files lying around that came in handy recently and I hadn&rsquo;t yet figured out where to put them.</p><p>There were also my config files. I&rsquo;m not a huge tinkerer when it comes to dotfiles, but my global gitconfig contained some aliases I relied on heavily and wasn&rsquo;t sure I could recreate/find again.</p><p>I&rsquo;ve also spent some time filling out my <code>.ssh/config</code> so I can easily access a bunch of servers without having to remember the matching private key, username, port, &mldr;</p><p>I&rsquo;ve been eyeing <a href=https://www.chezmoi.io>chezmoi</a> as a backup/versioning option and I finally took the leap. It&rsquo;s been a very pleasant experience and it didn&rsquo;t take half as long as I expected to get my environment versioned. I&rsquo;ve already started with some scripts to help get a clean system up to speed quickly.</p><p>I&rsquo;m glad I could recover from my mistake, but as always: no backup, no mercy! If you&rsquo;re reading this and think to yourself <em>wow, this sounds scary</em>&mldr;how about some backup? ðŸ˜Š</p><p>I can really recommend <a href=https://www.chezmoi.io>chezmoi</a> for dotfiles (and even some scripts you don&rsquo;t know where to put) and I&rsquo;m planning on adding another blog post about that experience soon.</p><p>Stay tuned and thanks for reading!</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Seriously Microsoft&mldr;you can&rsquo;t tell me that there&rsquo;s anybody who knows exactly what the magic error code 4294967295 means.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></article><a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/><img alt="Creative Commons Lizenzvertrag" style=border-width:0 src=https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png></a><br><span xmlns:dct=http://purl.org/dc/terms/ href=http://purl.org/dc/dcmitype/Text property="dct:title" rel=dct:type><i>How I accidentally corrupted my WSL virtual disk and what I learned from it</i></span> von <a xmlns:cc=http://creativecommons.org/ns# href=/tech/corrupted-my-wsl-virtual-disk/ property="cc:attributionName" rel=cc:attributionURL>Robert LÃ¼tzner</a> ist lizenziert unter einer <a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/>Creative Commons Namensnennung - Nicht-kommerziell - Weitergabe unter gleichen Bedingungen 4.0 International Lizenz</a>.</main><footer><p>Â© 2024 Robert LÃ¼tzner</p><a href=https://rollenspiel.social/@mforester rel=me target=blank>Mastodon</a> | <a href=https://codeberg.org/rluetzner>Codeberg</a> | <a href=/imprint/>Contact Me</a> | <a href=/posts/index.xml>RSS Feed</a></p></footer></body></html>