<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet type=text/css href="/css/readable.min.css?v=v1.1.0"><meta name=description content><link rel="shortcut icon" href=/images/favicon.ico type=image/x-icon><title>Schafe sind bessere Rasenmäher | .NET Framework and Code Coverage from the Terminal with OpenCover</title><meta name=fediverse:creator content="@mforester@rollenspiel.social"></head><body><header><h1>Schafe sind bessere Rasenmäher</h1><p>...ist einfach so!</p><figure><a href=/><img width=100 height=100 src=/images/schaf-rund.webp alt></a></figure><nav data-style=classy><span><a href=/posts/>Stuff</a>
</span><span><a href=/tech/>Tech</a>
</span><span><a href=/mindfulness/>Mindfulness</a>
</span><span><a href=/stories/>Geschichten</a></span></nav></header><main><h1>.NET Framework and Code Coverage from the Terminal with OpenCover</h1><i data-feather=calendar></i>
<time datetime=2024-04-12>12. Apr 2024</time><br><b>Tags: </b><i data-feather=tag></i>
<a class="btn btn-sm btn-outline-dark tag-btn" href=/tags/.net>.net</a>
<a class="btn btn-sm btn-outline-dark tag-btn" href=/tags/terminal>terminal</a>
<a class="btn btn-sm btn-outline-dark tag-btn" href=/tags/foss>foss</a><br><b>Estimated reading time: </b>4 minutes<article><blockquote><p>This is a condensed version of <a href=https://sbytestream.pythonanywhere.com/blog/Code-Coverage-For-NUnit>https://sbytestream.pythonanywhere.com/blog/Code-Coverage-For-NUnit</a> . Many thanks Siddharth Barman, I wouldn&rsquo;t have gotten this far without you.</p><p>Be advised that the <a href=https://github.com/opencover/opencover/>OpenCover</a> project has been archived and is no longer actively developed. There are FOSS alternatives available, but this is what I got working, so I&rsquo;ll stick with it until it breaks.</p></blockquote><p>I&rsquo;ve managed to move most of my development workflows to the terminal. However, one of the last few things that&rsquo;s been missing in my toolbelt, was gathering code coverage. Anything that uses <code>dotnet</code> (i.e. .NET Core 2 and newer) is easy. Besides, I have a CI that solves this for me.</p><p>But I also have a few legacy<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> projects that rely on Windows. CI support is sadly still <em>in progress</em> for those. For the longest time I thought, that there would be no way around VisualStudio <sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> when it comes to unit tests and code coverage.</p><p>So far, I had managed to get Neovim working on Windows and had even figured out how to sync my config files using chezmoi (Windows uses a different config path). I&rsquo;ve set up a few shortcuts and aliases in my PowerShell profile to build these legacy projects.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-PowerShell data-lang=PowerShell><span style=display:flex><span>
</span></span><span style=display:flex><span>New-Alias lg lazygit.exe
</span></span><span style=display:flex><span>New-Alias vi nvim.exe
</span></span><span style=display:flex><span>New-Alias vim nvim.exe
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> msbuild {
</span></span><span style=display:flex><span>  &amp; <span style=color:#e6db74>&#34;C:\Program Files (x86)\Microsoft Visual Studio\2022\BuildTools\MSBuild\Current\Bin\MSBuild.exe&#34;</span> <span style=color:#e6db74>&#34;/t:clean,build&#34;</span> <span style=color:#e6db74>&#34;/p:Configuration=Debug&#34;</span> <span style=color:#e6db74>&#34;/verbosity:m&#34;</span> <span style=color:#e6db74>&#34;/property:NoWarnings=True&#34;</span> <span style=color:#e6db74>&#34;/m:4&#34;</span> <span style=color:#e6db74>&#34;/clp:Summary;ErrorsOnly&#34;</span> <span style=color:#e6db74>&#34;/restore&#34;</span> <span style=color:#e6db74>&#34;</span>$args<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The <code>$args</code> allow me to use the <code>msbuild</code> function with any <code>*.sln</code> or <code>*.csproj</code> file.</p><p>Now, let&rsquo;s install a few things with Chocolatey.</p><aside><p><p>If you don&rsquo;t know about Chocolatey, you&rsquo;re missing out.</p><p>It&rsquo;s a package manager for Windows that makes it much easier to grab and install software than downloading installers or binaries off the internet. It also helps you keep things nice and updated.</p><p>Check it out <a href=https://chocolatey.org/>here</a>.</p></p></aside><p>We&rsquo;ll install three things:</p><ul><li><a href=https://nunit.org/><code>nunit</code></a>, which is what I&rsquo;m using as a testing framework,</li><li><a href=https://github.com/OpenCover/opencover><code>opencover</code></a>, which we&rsquo;ll use to generate an XML file with code coverage metrics and</li><li><a href=https://github.com/danielpalme/ReportGenerator><code>reportgenerator</code></a>, which will allow us to visualize the results in a nice and human readable way.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>choco install nunit opencover reportgenerator.portable
</span></span></code></pre></div><p>For code coverage to work, <code>opencover</code> needs to wrap the test method calls in our test project&rsquo;s <code>*.dll</code>, so it knows to record what&rsquo;s going on.<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup> For this I added another function to my <code>profile.ps1</code>.</p><blockquote><p><code>OpenCover.Console.exe</code>, <code>nunit3-console.exe</code>, <code>msbuild.exe</code> and <code>ReportGenerator.exe</code> are on my <code>PATH</code>, so I can call the executables directly without having to specify a long path. Chocolatey was able to solve some of this automatically, but I remember having to add at least one of the paths manually.</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#66d9ef>function</span> opencover {
</span></span><span style=display:flex><span>  &amp; <span style=color:#e6db74>&#34;OpenCover.Console.exe&#34;</span> <span style=color:#e6db74>&#34;-targetargs:</span>$args<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;-target:nunit3-console.exe&#34;</span> <span style=color:#e6db74>&#34;-output:C:\Temp\code-coverage.xml&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Basically, we tell it to run <code>nunit3-console.exe</code> under the hood and call that with <code>$args</code> (i.e. the test project DLL). The output will end up in <code>C:\Temp\code-coverage.xml</code>, from which we&rsquo;ll generate a report. We&rsquo;ll do this with yet another function.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#66d9ef>function</span> coverage-report {
</span></span><span style=display:flex><span>  &amp; <span style=color:#e6db74>&#34;ReportGenerator.exe&#34;</span> <span style=color:#e6db74>&#34;-reports:C:\Temp\code-coverage.xml&#34;</span> <span style=color:#e6db74>&#34;-targetdir:C:\Temp\report&#34;</span>
</span></span><span style=display:flex><span>  C:\Temp\report\index.html
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>coverage-report</code> takes the XML and generates a web page for us, that we can look at with our favorite browser. The first line of this function generates the web page, and the second line calls the <code>index.html</code> file directly, which will open up the page in the default browser.</p><p>And that is all the setup we need. Here&rsquo;s a quick example of how I use it.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>msbuild Stuff.sln
</span></span><span style=display:flex><span>opencover .\Stuff.Tests\bin\Debug\Stuff.Tests.dll
</span></span><span style=display:flex><span>coverage-report
</span></span></code></pre></div><p>Feel free to let me know if you&rsquo;ve learned something new or want to share how you&rsquo;re doing things.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>When I say <em>legacy</em>, I mean it! There&rsquo;s stuff that&rsquo;s .NET Framework 3.5, 4.0, 4.5, 4.6, 4.6.1, etc. And then there&rsquo;s projects that are .NET Core 2.1 or 3.0 or .NET Standard 2.0. And let&rsquo;s not stop there. Of course there are project dependencies that tie all this madness together into some weird Frankenstein&rsquo;s .NET monster.<br>All of that is a very long way of saying: forget <code>dotnet build</code>, forget <code>dotnet msbuild</code> and especially forget <code>dotnet test</code> &ndash; which would allow me to easily hook in code coverage adapters.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>I feel like it&rsquo;s still the easiest and most convenient way to develop .NET on Windows, but I&rsquo;m trying my damndest to move away from anything Microsoft.&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>The reality is of course a bit more complicated. I kinda understand what&rsquo;s going on, but I can&rsquo;t explain it well enough and it&rsquo;d be out of scope of this article anyway.&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></article><a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/><img alt="Creative Commons License" style=border-width:0 src=https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png></a><br><span xmlns:dct=http://purl.org/dc/terms/ href=http://purl.org/dc/dcmitype/Text property="dct:title" rel=dct:type><i>.NET Framework and Code Coverage from the Terminal with OpenCover</i></span> written by <a xmlns:cc=http://creativecommons.org/ns# href=/tech/net-framework-and-code-coverage-from-the-terminal/ property="cc:attributionName" rel=cc:attributionURL>Robert Lützner</a> is licensed under <a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/>Creative Commons Attribution - NonCommercial - ShareAlike 4.0 International license</a>.</main><footer><p>© 2024 Robert Lützner</p><a href=https://rollenspiel.social/@mforester rel=me target=blank>Mastodon</a> | <a href=https://codeberg.org/rluetzner>Codeberg</a> | <a href=/imprint/>Contact Me</a> | <a href=/rss>RSS Feeds</a> | <a href=/imprint>Imprint</a></p></footer></body></html>