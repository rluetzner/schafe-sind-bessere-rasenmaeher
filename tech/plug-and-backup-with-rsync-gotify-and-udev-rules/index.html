<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet type=text/css href="/css/readable.min.css?v=v1.1.0"><meta name=description content><link rel="shortcut icon" href=/images/favicon.ico type=image/x-icon><title>Schafe sind bessere Rasenmäher | Plug & Backup -- with Rsync, Gotify and udev rules</title>
<meta name=fediverse:creator content="@mforester@rollenspiel.social"></head><body><header><h1>Schafe sind bessere Rasenmäher</h1><p>...ist einfach so!</p><figure><a href=/><img width=100 height=100 src=/images/schaf-rund.webp alt></a></figure><nav data-style=classy><span><a href=/posts/>Stuff</a>
</span><span><a href=/tech/>Tech</a>
</span><span><a href=/mindfulness/>Mindfulness</a>
</span><span><a href=/stories/>Geschichten</a></span></nav></header><main><h1>Plug & Backup -- with Rsync, Gotify and udev rules</h1><i data-feather=calendar></i>
<time datetime=2024-10-19>19. Oct 2024</time><br><b>Tags: </b><i data-feather=tag></i>
<a class="btn btn-sm btn-outline-dark tag-btn" href=/tags/linux>linux</a>
<a class="btn btn-sm btn-outline-dark tag-btn" href=/tags/backup>backup</a>
<a class="btn btn-sm btn-outline-dark tag-btn" href=/tags/rsync>rsync</a>
<a class="btn btn-sm btn-outline-dark tag-btn" href=/tags/gotify>gotify</a>
<a class="btn btn-sm btn-outline-dark tag-btn" href=/tags/udev>udev</a><br><b>Estimated reading time: </b>8 minutes<article><p>This is gonna be a step-by-step reconstruction of how my backup script evolved over various iterations.</p><p>If you&rsquo;re just interested in the top-level steps, you can take a look at the section headings.</p><nav id=TableOfContents></nav><h2 id=starting-out-with-rsync>Starting out with rsync</h2><p>I&rsquo;m a big fan of <a href=https://restic.net>Restic</a> for backups. It&rsquo;s one of the first tools I install on a new system.</p><p>In this particular case however, I decided to use good old <code>rsync</code> instead. I&rsquo;m backing up the data for all my self-hosted stuff on my Raspberry Pi, including photos, documents and movies / TV shows I ripped from my physical media. There&rsquo;s a certain charm in just plugging the backup disk into any PC and accessing the files directly.</p><p>At it&rsquo;s inception, the script pretty much looked something like this.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>set -o errexit
</span></span><span style=display:flex><span>set -o nounset
</span></span><span style=display:flex><span>set -o pipefail
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rsync -avP /home/pi/ /mnt/backup/home/
</span></span></code></pre></div><p>I&rsquo;m not going to explain <code>rsync</code> and all it&rsquo;s options, because that&rsquo;s out of scope for this post. It&rsquo;s also not really helpful. You decide what you want to use as a backup tool and it doesn&rsquo;t need to be <code>rsync</code> at all.</p><p>Now, let&rsquo;s quickly go over the steps involved in backing up my data.</p><ol><li>Plug in portable USB disk.</li><li><code>ssh</code> into the Pi.</li><li>Run <code>lsblk</code> to figure out which <code>/dev/sdX</code> I want to mount.</li><li>Run <code>sudo mount /dev/sdX /mnt/backup</code>.</li><li>Run <code>./local-backup.sh</code>.</li><li>Check in after a few hours and see if the script is done.</li><li>Run <code>sudo umount /mnt/backup</code>.</li><li>Unplug the disk.</li></ol><p>Easy, right?</p><p>In hindsight I&rsquo;m a bit embarrassed to admit that I stopped here for quite some time. Any backup is better than no backup and ideas for improvement came to me bit by bit over time.</p><h2 id=introducing-gotify>Introducing Gotify</h2><p><a href=https://gotify.net/>Gotify</a> is <em>&ldquo;a simple server for sending and receiving messages&rdquo;</em>. I specifically want to highlight that it makes sending push notifications to your phone (or other clients) exceedingly easy.</p><p>I discovered <em>Gotify</em> while looking for something else entirely, but was immediately taken by how simple it is to set up and use.</p><p>I don&rsquo;t host my own <em>Gotify</em> instance, but you easily could. I&rsquo;m using the instance hosted by <a href=https://push.adminforge.de/>AdminForge</a> and I&rsquo;m very happy with it. The people behind <em>AdminForge</em> are hosting a ton of great services and are also active on the <a href=https://kanoa.de/@adminforge>Fediverse</a>. Check them out if you want.</p><p>In the steps I&rsquo;ve listed above, Gotify &ndash; or rather <code>gotify-cli</code> helps me specifically with</p><blockquote><ol start=6><li>Check in after a few hours and see if the script is done.</li></ol></blockquote><p>So let&rsquo;s adjust the script a bit.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>set -o errexit
</span></span><span style=display:flex><span>set -o nounset
</span></span><span style=display:flex><span>set -o pipefail
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rsync -avP /home/pi/ /mnt/backup/home/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gotify-cli p -t Local-Backup <span style=color:#e6db74>&#34;Backup is done.&#34;</span>
</span></span></code></pre></div><aside><p>You&rsquo;ll need to run <code>gotify-cli init</code> first to login to the server you&rsquo;re using.</p></aside><p>Sweet. Now I get a push notification on my phone. Let&rsquo;s revise the steps.</p><ol><li>Plug in portable USB disk.</li><li><code>ssh</code> into the Pi.</li><li>Run <code>lsblk</code> to figure out which <code>/dev/sdX</code> I want to mount.</li><li>Run <code>sudo mount /dev/sdX /mnt/backup</code>.</li><li>Run <code>./local-backup.sh</code>.</li><li>Get notified that the backup is done.</li><li><code>ssh</code> into the Pi.</li><li>Run <code>sudo umount /mnt/backup</code>.</li><li>Unplug the disk.</li></ol><p>Well, it&rsquo;s now 9 steps instead of 8, but it got a bit more convenient. If you&rsquo;re observant, you&rsquo;ll have noticed that <em>and see if the script is done</em> implies that it very well could still be running and I&rsquo;d have to check in multiple times. And step 6 doesn&rsquo;t really require me to do anything but notice the notification on my phone.</p><p>What&rsquo;s next?</p><h2 id=unmount-the-disk>Unmount the disk</h2><p>This seemed like the logical next step. No need to log onto the server again.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>set -o errexit
</span></span><span style=display:flex><span>set -o nounset
</span></span><span style=display:flex><span>set -o pipefail
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rsync -avP /home/pi/ /mnt/backup/home/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo umount /mnt/backup
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gotify-cli p -t Local-Backup <span style=color:#e6db74>&#34;Backup is done and disk is unmounted.&#34;</span>
</span></span></code></pre></div><p>I also adjusted the notification message, so I have a reminder that I can just unplug the disk.</p><p>Let&rsquo;s look at our steps.</p><ol><li>Plug in portable USB disk.</li><li><code>ssh</code> into the Pi.</li><li>Run <code>lsblk</code> to figure out which <code>/dev/sdX</code> I want to mount.</li><li>Run <code>sudo mount /dev/sdX /mnt/backup</code>.</li><li>Run <code>./local-backup.sh</code>.</li><li>Get notified that the backup is done and disk is unmounted.</li><li>Unplug the disk.</li></ol><h2 id=finding-the-right-disk-by-uuid>Finding the right disk by UUID</h2><p>I added some code to make the script safer with <code>findmnt</code>. This ensures that I don&rsquo;t accidentally copy tons of data onto the same disk and run out of space.</p><p>While I added the code, I realized that I can also use this to mount the disk if it is unmounted. I usually work with the <code>sdX</code> devices when I mount disks manually, but you can also find the right device in <code>/dev/disk/by-uuid/</code>. The easiest way to figure out which disk you want is to run <code>ls -l /dev/disk/by-uuid/</code>, because it will show you to which devices the UUIDs are symlinked.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>set -o errexit
</span></span><span style=display:flex><span>set -o nounset
</span></span><span style=display:flex><span>set -o pipefail
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> ! findmnt /mnt/backup; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        sudo mount /dev/disk/by-uuid/1989f5f5-b0f6-4dfa-8677-63d20bdc044d /mnt/backup/
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rsync -avP /home/pi/ /mnt/backup/home/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo umount /mnt/backup
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gotify-cli p -t Local-Backup <span style=color:#e6db74>&#34;Backup is done and disk is unmounted.&#34;</span>
</span></span></code></pre></div><p>That leaves us with the following steps.</p><ol><li>Plug in portable USB disk.</li><li><code>ssh</code> into the Pi.</li><li>Run <code>./local-backup.sh</code>.</li><li>Get notified that the backup is done and disk is unmounted.</li><li>Unplug the disk.</li></ol><p>Now we&rsquo;re talking. This is pretty usable and I ran this for a very long time.</p><p>There&rsquo;s a good reason for that, because the next step &ndash; while obvious &ndash; took some work and experimentation. Let&rsquo;s get to it.</p><h2 id=automating-away-the-rest-with-a-udev-rule-and-a-service>Automating away the rest with a udev rule and a service</h2><p>Linux is amazing. While Windows as an OS will do it&rsquo;s damndest to hide information from you, Linux just gives you access to everything.</p><p>With full knowledge of what&rsquo;s going on with the systems, we can find out when a specific device is plugged in. That&rsquo;s where <code>udev</code> comes in.</p><p>As far as I understand, <code>udev</code> is responsible for creating the device files in <code>/dev</code> when a device is detected. But it also allows you to define additional rules as to what should happen when a device is added, removed, etc.</p><p>We want this for a rule like this: <em>if this specific USB disk is connected, run our local-backup.sh script</em>.</p><p>Now there&rsquo;s one thing to look out for with <code>udev</code>. You can&rsquo;t run a long running processes, because it would block other kernel operations. But we can assume that backing up 4TB of data might take some time &ndash; even if <code>rsync</code> will only copy changed files.</p><p>What we can do instead of running the script itself, is to start a <code>systemd</code> service. That only takes a few milliseconds and will run happily in the background.</p><p>So let&rsquo;s write all this out.</p><h3 id=homepiconfigsystemduserlocal-backupservice>/home/pi/.config/systemd/user/local-backup.service</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>Unit<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>Description <span style=color:#f92672>=</span> Back up files to a local disk
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>Service<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>Type <span style=color:#f92672>=</span> simple
</span></span><span style=display:flex><span>ExecStart <span style=color:#f92672>=</span> /bin/bash -c <span style=color:#e6db74>&#34;cd %h; /usr/bin/sleep 10; ./local-backup.sh&#34;</span>
</span></span><span style=display:flex><span>StandardOutput <span style=color:#f92672>=</span> journal
</span></span><span style=display:flex><span>StandardError <span style=color:#f92672>=</span> inherit
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>Install<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>WantedBy <span style=color:#f92672>=</span> default.target
</span></span></code></pre></div><p>Make sure to run <code>systemctl --user daemon-reload</code>, so <code>systemd</code> is aware of the new service.</p><p>Two things to note.</p><ol><li>We use <code>cd %h</code> to change to the home directory. <code>%h</code> is a builtin variable for the user&rsquo;s home directory in <code>systemd</code>.</li><li>We <code>sleep 10</code> to make sure that the disk is ready and our <code>mount</code> command won&rsquo;t fail, because we&rsquo;re too quick.</li></ol><h3 id=homepirun-backup-servicesh>/home/pi/run-backup-service.sh</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e># Take care! This doesn&#39;t work without setting the XDG_RUNTIME_DIR env variable.</span>
</span></span><span style=display:flex><span>/usr/bin/sudo -u pi XDG_RUNTIME_DIR<span style=color:#f92672>=</span>/run/user/<span style=color:#66d9ef>$(</span>id -u pi<span style=color:#66d9ef>)</span> systemctl --no-block --user start local-backup.service
</span></span></code></pre></div><h3 id=etcudevrulesd99-backup-diskrules>/etc/udev/rules.d/99-backup-disk.rules</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ATTR<span style=color:#f92672>{</span>idVendor<span style=color:#f92672>}==</span><span style=color:#e6db74>&#34;0bc2&#34;</span>, ATTR<span style=color:#f92672>{</span>idProduct<span style=color:#f92672>}==</span><span style=color:#e6db74>&#34;2344&#34;</span>, ACTION<span style=color:#f92672>==</span><span style=color:#e6db74>&#34;add&#34;</span>, RUN<span style=color:#f92672>+=</span><span style=color:#e6db74>&#34;/home/pi/run-backup-service.sh&#34;</span>
</span></span></code></pre></div><p>How did I figure out these cryptic <code>idVendor</code> and <code>idProduct</code> values?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>udevadm info -a -n /dev/sdc | grep <span style=color:#e6db74>&#39;{id&#39;</span>
</span></span></code></pre></div><p>Don&rsquo;t worry that this command will show you multiple matches. If you remove the <code>grep</code> command it will tell you the following.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>udevadm info -a -n /dev/sdc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Udevadm info starts with the device specified by the devpath and <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>walks up the chain of parent devices. It prints <span style=color:#66d9ef>for</span> every device
</span></span><span style=display:flex><span>found, all possible attributes in the udev rules key format.
</span></span><span style=display:flex><span>A rule to match, can be composed by the attributes of the device
</span></span><span style=display:flex><span>and the attributes from one single parent device.
</span></span></code></pre></div><p>To enable this rule, you&rsquo;ll need to run <code>sudo udevadm control --reload-rules && sudo udevadm trigger</code>.</p><aside><p>I tried running the <code>systemctl start</code> command from <code>run-backup-service.sh</code> directly in the <code>udev</code> rule, but it didn&rsquo;t work and I wasn&rsquo;t willing to put endless work into it.
It works with the script and I&rsquo;m happy enough with that.</p></aside><h2 id=finishing-touches----add-a-trap-for-errors>Finishing touches &ndash; add a trap for errors</h2><p>As a bonus, I added a <code>trap</code> to the backup script. If anything goes wrong, it should send out a notification so I know I need to check for errors.</p><p>This is the final version of my backup script. I&rsquo;m adding comments, so you should be able to copy and adjust it as needed.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>set -o errexit
</span></span><span style=display:flex><span>set -o nounset
</span></span><span style=display:flex><span>set -o pipefail
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Add a trap for errors. If anything goes wrong, we want to be notified.</span>
</span></span><span style=display:flex><span>trap <span style=color:#e6db74>&#39;gotify-cli p -t Local-Backup &#34;Something went wrong.&#34;&#39;</span> EXIT
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Check if /mnt/backup is already mounted, otherwise look for our backup disk</span>
</span></span><span style=display:flex><span><span style=color:#75715e># and mount it by UUID.</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> ! findmnt /mnt/backup; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        sudo mount /dev/disk/by-uuid/1989f5f5-b0f6-4dfa-8677-63d20bdc044d /mnt/backup/
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Backup all the stuff.</span>
</span></span><span style=display:flex><span>rsync -avP /home/pi/ /mnt/backup/home/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># We&#39;re done. Unmount the disk.</span>
</span></span><span style=display:flex><span>sudo umount /mnt/backup
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Unset the trap. If we didn&#39;t do this, we&#39;d get an error notification, even</span>
</span></span><span style=display:flex><span><span style=color:#75715e># when the script exits successfully.</span>
</span></span><span style=display:flex><span>trap <span style=color:#e6db74>&#34;&#34;</span> EXIT
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Send the &#34;All OK&#34; notification, so we know we can unplug the disk.</span>
</span></span><span style=display:flex><span>gotify-cli p -t Local-Backup <span style=color:#e6db74>&#34;Backup is done and disk is unmounted.&#34;</span>
</span></span></code></pre></div><h2 id=conclusion>Conclusion</h2><p>So let&rsquo;s look at our remaining steps.</p><ol><li>Plug in portable USB disk.</li><li>Get notified that the backup is done and disk is unmounted.</li><li>Unplug the disk.</li></ol><p>Pretty good, don&rsquo;t you think?</p><p>Let me know if this helped you or not. 🙂</p></article><a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/><img alt="Creative Commons License" style=border-width:0 src=https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png></a><br><span xmlns:dct=http://purl.org/dc/terms/ href=http://purl.org/dc/dcmitype/Text property="dct:title" rel=dct:type><i>Plug & Backup -- with Rsync, Gotify and udev rules</i></span> written by <a xmlns:cc=http://creativecommons.org/ns# href=/tech/plug-and-backup-with-rsync-gotify-and-udev-rules/ property="cc:attributionName" rel=cc:attributionURL>Robert Lützner</a> is licensed under <a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/>Creative Commons Attribution - NonCommercial - ShareAlike 4.0 International license</a>.</main><footer><p>© 2024 Robert Lützner</p><a href=https://rollenspiel.social/@mforester rel=me target=blank>Mastodon</a> | <a href=https://codeberg.org/rluetzner>Codeberg</a> | <a href=/imprint/>Contact Me</a> | <a href=/rss>RSS Feeds</a> | <a href=/imprint>Imprint</a></p></footer></body></html>