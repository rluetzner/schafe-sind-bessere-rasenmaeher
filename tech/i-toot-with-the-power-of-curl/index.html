<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet type=text/css href="/css/readable.min.css?v=v1.1.0"><meta name=description content><link rel="shortcut icon" href=/images/favicon.ico type=image/x-icon><title>Schafe sind bessere Rasenmäher | I toot with the power of cURL</title></head><body><header><h1>Schafe sind bessere Rasenmäher</h1><p>...ist einfach so!</p><figure><a href=/><img width=100 height=100 src=/images/schaf-rund.webp alt></a></figure><nav data-style=classy><span><a href=/posts/>Stuff</a>
</span><span><a href=/tech/>Tech</a>
</span><span><a href=/mindfulness/>Mindfulness</a>
</span><span><a href=/stories/>Geschichten</a></span></nav></header><main><h1>I toot with the power of cURL</h1><i data-feather=calendar></i>
<time datetime=2022-11-01>1. Nov 2022</time><br><b>Tags: </b><i data-feather=tag></i>
<a class="btn btn-sm btn-outline-dark tag-btn" href=/tags/mastodon>mastodon</a>
<a class="btn btn-sm btn-outline-dark tag-btn" href=/tags/curl>curl</a><br><b>Estimated reading time: </b>6 minutes<article><p>I spent the last two days trying to make a simple script that toots a static message on Mastodon. The idea came to me, because my instance admin is determined to welcome all new users to the instance. He&rsquo;s been using the same message for a while, but when asked he admited that he puts them together manually every time.</p><p>As I&rsquo;m not familiar with administrating a Mastodon instance, I offered to help in automating the part of the process sending out a welcome toot. Here&rsquo;s my journey including the pitfalls.</p><p>You can find the working script <a href=https://codeberg.org/RollenspielMonster/rollenspiel.social/src/branch/master/simple-toot>here</a>.</p><h2 id=starting-out-ie-registering-a-new-client-application>Starting out, i.e. registering a new client application</h2><p>I asked my good friend <a href=https://startpage.com>Startpage</a> for advice and promptly crashlanded on the Mastondon API documentation. If I were a more determined person I might have stayed there (and saved myself a bit of trouble), but I&rsquo;m lazy. So I went looking further and found <a href=https://leancrew.com/all-this/2018/08/autotooting-with-mastodon/>this article from leancrew.com</a>.</p><p>I quickly scanned the article (which I found way too long to actually read) for the necessary cURL commands. The first one I found was this (adjusted to my use-case):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Register a new client application.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Works like a charm.</span>
</span></span><span style=display:flex><span>curl -X POST <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -F <span style=color:#e6db74>&#34;client_name=simple-toot&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -F <span style=color:#e6db74>&#34;redirect_uris=urn:ietf:wg:oauth:2.0:oob&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -F <span style=color:#e6db74>&#34;scopes=write&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -F <span style=color:#e6db74>&#34;website=https://rollenspiel.social&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    https://rollenspiel.social/api/v1/apps
</span></span></code></pre></div><p>The output is an easy to understand JSON that contains the desired client ID and secret values.</p><h2 id=getting-an-access-token----the-wrong-way>Getting an access token &ndash; the wrong way</h2><p>The next step in the process is to retrieve an access token from the server. Seemingly that is another simple POST request:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># WARNING! This code uses deprecated parameters.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl -X POST <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -F <span style=color:#e6db74>&#34;client_id=&lt;CLIENT-ID&gt;&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -F <span style=color:#e6db74>&#34;client_secret=&lt;CLIENT-SECRET&gt;&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -F <span style=color:#e6db74>&#34;scope=write&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -F <span style=color:#e6db74>&#34;grant_type=password&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -F <span style=color:#e6db74>&#34;username=&lt;USERNAME&gt;&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -F <span style=color:#e6db74>&#34;password=&lt;PASSWORD&gt;&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    https://rollenspiel.social/oauth/token
</span></span></code></pre></div><p>This however does not work. At this point I was confident enough (again) with cURL&rsquo;s syntax to attempt reading the <a href=https://docs.joinmastodon.org/methods/apps/oauth/#obtain-a-token>Mastodon API docs</a> directly. It was also getting pretty late and I wanted to get this done as quickly as possible, so I scanned the documentation for interesting keywords. I discovered that <code>grant_type=password</code> no longer exists and it should read <code>grant_type=client_credentials</code> instead. Or so I thought. More on that later.</p><p>I also had to add the same <code>redirect_uri</code> I used when registering the client app in the first step.</p><p>The updated request therefore looked something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># WARNING! This code will work, but it is not what we want.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Check below for the right code and an explanation why.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl -X POST <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -F <span style=color:#e6db74>&#34;client_id=&lt;CLIENT-ID&gt;&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -F <span style=color:#e6db74>&#34;client_secret=&lt;CLIENT-SECRET&gt;&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -F <span style=color:#e6db74>&#34;scope=write&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -F <span style=color:#e6db74>&#34;grant_type=client_credentials&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -F <span style=color:#e6db74>&#34;redirect_uri=urn:ietf:wg:oauth:2.0:oob&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -F <span style=color:#e6db74>&#34;username=&lt;USERNAME&gt;&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -F <span style=color:#e6db74>&#34;password=&lt;PASSWORD&gt;&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    https://rollenspiel.social/oauth/token
</span></span></code></pre></div><p>This completed successfully and returned a JSON containing the desired access token element.</p><h2 id=sending-a-toot-without-the-proper-permissions-or-why-the-f-isnt-this-working>Sending a toot without the proper permissions or WHY THE F*!= ISN&rsquo;T THIS WORKING???</h2><p>The last step, now that we have the user-specific access token for our app, is to actually toot a message. The leancrew.com article I used as a tutorial resorted to using Python here, but I wanted to keep this as simple as possible.</p><aside><p><p>I still ended up with Python in the script, because I figured it would be the safest way to parse a value from a JSON string.</p><p><code>jq</code> is also an option, but the chance that <code>python</code> is already installed is basically 100% and at least in my experience <code>jq</code> has to be installed manually at some point.</p></p></aside><p>This should work:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># This will work in the end, but not right now!</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TEXT<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;this is
</span></span></span><span style=display:flex><span><span style=color:#e6db74>a multiline
</span></span></span><span style=display:flex><span><span style=color:#e6db74>text.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>it
</span></span></span><span style=display:flex><span><span style=color:#e6db74>should
</span></span></span><span style=display:flex><span><span style=color:#e6db74>work
</span></span></span><span style=display:flex><span><span style=color:#e6db74>(hopefully).&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl -s -X POST <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -H <span style=color:#e6db74>&#34;Authorization: Bearer </span><span style=color:#e6db74>${</span>ACCESS_TOKEN<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -F <span style=color:#e6db74>&#34;status=</span><span style=color:#e6db74>${</span>TEXT<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	-F <span style=color:#e6db74>&#34;visibility=direct&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    https://rollenspiel.social/api/v1/statuses
</span></span></code></pre></div><p>This however kept returning the following error:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>HTTP Error 422: This method requires an authenticated user.
</span></span></code></pre></div><p>What the hell? I received an access token without error, why shouldn&rsquo;t it work.</p><p>I tried adding quotes to the <code>$ACCESS_TOKEN</code> variable, but then the error message stated that the access token wasn&rsquo;t valid. So the syntax and the token itself weren&rsquo;t the problem.</p><p>At this point I gave up for the day. I took all the information I had until now and put it into a <a href=https://rollenspiel.social/@mforester/109264958526719952>toot</a>.</p><h2 id=learning-to-read-again-or-getting-an-access-token----the-right-way>Learning to read (again) or getting an access token &ndash; the right way</h2><p>When I came back the next day I went straight for the Mastodon API docs again. I had gotten a few answers to my toot, but neither a solution nor an explanation.</p><p>What bugged me was that the different errors from before told me that I had a valid access token. But for whatever reason &ndash; even though I had specifically requested a &lsquo;write&rsquo; scope &ndash; the access token didn&rsquo;t have the necessary permissions to toot in my name.</p><p>After just a few minutes I found this exact piece of information in the documentation of the POST request I used earlier.</p><blockquote><p><strong>grant_type (REQUIRED)</strong> &ndash; <em>string</em> &ndash; Set equal to <code>authorization_code</code> if code is provided in order to gain user-level access. Otherwise, set equal to <code>client_credentials</code> to obtain app-level access only.</p></blockquote><p><em>User-level access</em>? Be still my heart!</p><p>As it turns out there was another step missing. A step that (at least for me) brought it all into focus.</p><p>At the very top of the <a href=https://docs.joinmastodon.org/methods/apps/oauth/#obtain-a-token>docs page</a> where I was looking was a GET request to prompt the user to authorize a given client app. That is also what I&rsquo;ve seen other apps, e.g. Tusky, do. It also gets rid of the username and password, which not only cleans up the script, but also makes it a bit safer in my opinion. If it never even knows the user&rsquo;s credentials there&rsquo;s nothing harmful it could do with them.</p><p>So the final piece of the puzzle looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>echo <span style=color:#e6db74>&#34;https://rollenspiel.social/oauth/authorize?response_type=code&amp;client_id=</span><span style=color:#e6db74>${</span>CLIENT_ID<span style=color:#e6db74>}</span><span style=color:#e6db74>&amp;redirect_uri=urn:ietf:wg:oauth:2.0:oob&amp;scope=write&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>read -p <span style=color:#e6db74>&#34;Enter the authorization code: &#34;</span> AUTH_CODE
</span></span></code></pre></div><p>The user has to open up a specific URL in their browser, log in and authorize the app to access their account. As I&rsquo;ve seen in other CLI tools (e.g. RClone) I simply prompt the user to paste the authorization code.</p><p>With this we can get <em>user-level</em> access by modifying the POST request we used earlier to receive an access token:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -s -X POST <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        -F <span style=color:#e6db74>&#34;client_id=</span><span style=color:#e6db74>${</span>CLIENT_ID<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        -F <span style=color:#e6db74>&#34;client_secret=</span><span style=color:#e6db74>${</span>CLIENT_SECRET<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        -F <span style=color:#e6db74>&#34;scope=write&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        -F <span style=color:#e6db74>&#34;grant_type=authorization_code&#34;</span><span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        -F <span style=color:#e6db74>&#34;code=</span><span style=color:#e6db74>${</span>AUTH_CODE<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        -F <span style=color:#e6db74>&#34;redirect_uri=urn:ietf:wg:oauth:2.0:oob&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        https://rollenspiel.social/oauth/token
</span></span></code></pre></div><p>Notice that the <code>username</code> and <code>password</code> are gone. We use <code>grant_type=authorization_code</code> and hand over the code the user pasted earlier.</p><p>This returns an access token that has the necessary permissions. The toot command from earlier now works without any modifications.</p><h2 id=wrap-up>Wrap-up</h2><p>The entire process goes something like this:</p><ol><li>Register a new client app with the server, i.e. receive a client id and secret.</li><li>Prompt the user to visit a URL and authorize the tool to access their account. The user has to copy and paste an authorization code.</li><li>Get an access token using the authorization code from the previous step.</li><li>Toot!</li></ol><p>Steps 1-3 are one-time only. As long as we have an access token, there&rsquo;s no reason to go through this process again.</p><p>Again, look up the final script <a href=https://codeberg.org/RollenspielMonster/rollenspiel.social/src/branch/master/simple-toot>here</a> and feel free to use it and/or send in any improvements.</p></article><a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/><img alt="Creative Commons License" style=border-width:0 src=https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png></a><br><span xmlns:dct=http://purl.org/dc/terms/ href=http://purl.org/dc/dcmitype/Text property="dct:title" rel=dct:type><i>I toot with the power of cURL</i></span> written by <a xmlns:cc=http://creativecommons.org/ns# href=/tech/i-toot-with-the-power-of-curl/ property="cc:attributionName" rel=cc:attributionURL>Robert Lützner</a> is licensed under <a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/>Creative Commons Attribution - NonCommercial - ShareAlike 4.0 International license</a>.</main><footer><p>© 2024 Robert Lützner</p><a href=https://rollenspiel.social/@mforester rel=me target=blank>Mastodon</a> | <a href=https://codeberg.org/rluetzner>Codeberg</a> | <a href=/imprint/>Contact Me</a> | <a href=/rss>RSS Feeds</a> | <a href=/imprint>Imprint</a></p></footer></body></html>