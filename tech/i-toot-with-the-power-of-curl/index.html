<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>I toot with the power of cURL | Schafe sind bessere Rasenmäher</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="I spent the last two days trying to make a simple script that toots a static message on Mastodon. The idea came to me, because my instance admin is determined to welcome all new users to the instance. He&rsquo;s been using the same message for a while, but when asked he admited that he puts them together manually every time.
As I&rsquo;m not familiar with administrating a Mastodon instance, I offered to help in automating the part of the process sending out a welcome toot."><meta name=generator content="Hugo 0.105.0"><meta name=robots content="noindex, nofollow"><link rel=stylesheet href=/ananke/css/main.min.css><link rel="shortcut icon" href=/images/favicon.ico type=image/x-icon><meta property="og:title" content="I toot with the power of cURL"><meta property="og:description" content="I spent the last two days trying to make a simple script that toots a static message on Mastodon. The idea came to me, because my instance admin is determined to welcome all new users to the instance. He&rsquo;s been using the same message for a while, but when asked he admited that he puts them together manually every time.
As I&rsquo;m not familiar with administrating a Mastodon instance, I offered to help in automating the part of the process sending out a welcome toot."><meta property="og:type" content="article"><meta property="og:url" content="https://www.schafe-sind-bessere-rasenmaeher.de/tech/i-toot-with-the-power-of-curl/"><meta property="article:section" content="tech"><meta property="article:published_time" content="2022-11-01T20:56:12+01:00"><meta property="article:modified_time" content="2022-11-01T20:56:12+01:00"><meta itemprop=name content="I toot with the power of cURL"><meta itemprop=description content="I spent the last two days trying to make a simple script that toots a static message on Mastodon. The idea came to me, because my instance admin is determined to welcome all new users to the instance. He&rsquo;s been using the same message for a while, but when asked he admited that he puts them together manually every time.
As I&rsquo;m not familiar with administrating a Mastodon instance, I offered to help in automating the part of the process sending out a welcome toot."><meta itemprop=datePublished content="2022-11-01T20:56:12+01:00"><meta itemprop=dateModified content="2022-11-01T20:56:12+01:00"><meta itemprop=wordCount content="1182"><meta itemprop=keywords content="mastodon,curl,"><meta name=twitter:card content="summary"><meta name=twitter:title content="I toot with the power of cURL"><meta name=twitter:description content="I spent the last two days trying to make a simple script that toots a static message on Mastodon. The idea came to me, because my instance admin is determined to welcome all new users to the instance. He&rsquo;s been using the same message for a while, but when asked he admited that he puts them together manually every time.
As I&rsquo;m not familiar with administrating a Mastodon instance, I offered to help in automating the part of the process sending out a welcome toot."></head><body class="ma0 avenir bg-near-white"><header><div class=bg-dark-gray><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib"><img src=/images/schaf-rund.png class="w100 mw5-ns" alt="Schafe sind bessere Rasenmäher"></a><div class="flex-l items-center"><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/posts/ title="Stuff page">Stuff</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/tech/ title="Tech page">Tech</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/stories/ title="Geschichten page">Geschichten</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/about/ title="About page">About</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/imprint/ title="Imprint page">Imprint</a></li></ul><div class=ananke-socials><a href=https://rollenspiel.social/@mforester target=_blank class="mastodon ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="Mastodon link" rel=me aria-label="follow on Mastodon——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 230 230" viewBox="0 0 230 230" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M211.80683 139.0875c-3.1825 16.36625-28.4925 34.2775-57.5625 37.74875-15.16 1.80875-30.0825 3.47125-45.99875 2.74125-26.0275-1.1925-46.565-6.2125-46.565-6.2125.0 2.53375.15625 4.94625.46875 7.2025 3.38375 25.68625 25.47 27.225 46.3925 27.9425 21.115.7225 39.91625-5.20625 39.91625-5.20625l.86875 19.09s-14.77 7.93125-41.08125 9.39c-14.50875.7975-32.52375-.365-53.50625-5.91875C9.23183 213.82 1.40558 165.31125.20808 116.09125c-.36375-14.61375-.14-28.39375-.14-39.91875.0-50.33 32.97625-65.0825 32.97625-65.0825C49.67058 3.45375 78.20308.2425 107.86433.0h.72875c29.66125.2425 58.21125 3.45375 74.8375 11.09.0.0 32.97625 14.7525 32.97625 65.0825.0.0.4125 37.13375-4.6 62.915" style="fill-rule:evenodd;clip-rule:evenodd"/><path d="M65.68743 96.45938c0 9.01375-7.3075 16.32125-16.3225 16.32125-9.01375.0-16.32-7.3075-16.32-16.32125.0-9.01375 7.30625-16.3225 16.32-16.3225 9.015.0 16.3225 7.30875 16.3225 16.3225M124.52893 96.45938c0 9.01375-7.30875 16.32125-16.3225 16.32125s-16.32125-7.3075-16.32125-16.32125c0-9.01375 7.3075-16.3225 16.32125-16.3225 9.01375.0 16.3225 7.30875 16.3225 16.3225M183.36933 96.45938c0 9.01375-7.3075 16.32125-16.32125 16.32125s-16.32125-7.3075-16.32125-16.32125c0-9.01375 7.3075-16.3225 16.32125-16.3225s16.32125 7.30875 16.32125 16.3225" fill="#fff"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a><a href=https://codeberg.org/rluetzner target=_blank class="codeberg ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="codeberg link" rel=noopener aria-label="follow on codeberg——Opens in a new window"><span class=icon><svg viewBox="0 0 512 512" id="svg15" sodipodi:docname="codeberg.svg" inkscape:version="1.2.1 (9c6d41e410, 2022-07-14)" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><defs id="defs19"><filter style="color-interpolation-filters:sRGB" inkscape:label="Lightness-Contrast" id="filter1778" x="0" y="0" width="1" height="1"><feColorMatrix values="0.21 0.72 0.072 0 0 0.21 0.72 0.072 0 0 0.21 0.72 0.072 0 0 0 0 0 1 0" id="feColorMatrix1776" result="fbSourceGraphic"/><feColorMatrix result="fbSourceGraphicAlpha" in="fbSourceGraphic" values="0 0 0 -1 0 0 0 0 -1 0 0 0 0 -1 0 0 0 0 1 0" id="feColorMatrix1873"/><feColorMatrix id="feColorMatrix1875" values="1 0 0 0.253601 -0 0 1 0 0.253601 -0 0 0 1 0.253601 -0 0 0 0 1 0" in="fbSourceGraphic"/></filter><filter style="color-interpolation-filters:sRGB" inkscape:label="Lightness-Contrast" id="filter1782" x="0" y="0" width="1" height="1"><feColorMatrix values="0.21 0.72 0.072 0 0 0.21 0.72 0.072 0 0 0.21 0.72 0.072 0 0 0 0 0 1 0" id="feColorMatrix1780" result="fbSourceGraphic"/><feColorMatrix result="fbSourceGraphicAlpha" in="fbSourceGraphic" values="0 0 0 -1 0 0 0 0 -1 0 0 0 0 -1 0 0 0 0 1 0" id="feColorMatrix1877"/><feColorMatrix id="feColorMatrix1879" values="1 0 0 0.253601 -0 0 1 0 0.253601 -0 0 0 1 0.253601 -0 0 0 0 1 0" in="fbSourceGraphic"/></filter><filter style="color-interpolation-filters:sRGB" inkscape:label="Greyscale" id="filter1786" x="0" y="0" width="1" height="1"><feColorMatrix values="0.21 0.72 0.072 0 0 0.21 0.72 0.072 0 0 0.21 0.72 0.072 0 0 0 0 0 1 0" id="feColorMatrix1784"/></filter></defs><sodipodi:namedview id="namedview17" pagecolor="#ffffff" bordercolor="#666666" borderopacity="1" inkscape:showpageshadow="2" inkscape:pageopacity="0" inkscape:pagecheckerboard="0" inkscape:deskcolor="#d1d1d1" showgrid="false" inkscape:zoom="1.5332031" inkscape:cx="256" inkscape:cy="204.14777" inkscape:window-width="1920" inkscape:window-height="951" inkscape:window-x="0" inkscape:window-y="32" inkscape:window-maximized="1" inkscape:current-layer="svg15"/><linearGradient id="a" gradientUnits="userSpaceOnUse" x1="259.804" x2="383.132" y1="161.4" y2="407.835"><stop offset="0" stop-color="#fff" stop-opacity="0" id="stop2"/><stop offset=".5" stop-color="#71c2ff" id="stop4"/><stop offset="1" stop-color="#39aaff" id="stop6"/></linearGradient><path d="m259.804 161.4c-.44.0-1.1.0-1.32.44l-.44 1.1 73.996 277.27a192.039 192.039.0 0086.77-74.437L261.125 162.06a1.762 1.762.0 00-1.321-.661z" fill="url(#a)" opacity=".5" id="path11" style="fill:url(#a);filter:url(#filter1782)" transform="matrix(1.3242691,0,0,1.3242691,-82.717006,-82.736123)"/><path d="m255.3 71.8a192 192 0 00-162 294l160.1-207c.5-.6 1.5-1 2.6-1s2 .4 2.6 1l160 207a192 192 0 0029.4-102c0-106-86-192-192-192a192 192 0 00-.7.0z" fill="#2185d0" id="path13" style="filter:url(#filter1778)" transform="matrix(1.3242691,0,0,1.3242691,-82.717006,-82.736123)"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a><a href=https://gitlab.com/rluetzner target=_blank class="gitlab ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="GitLab link" rel=noopener aria-label="follow on GitLab——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M29.782 199.732 256 493.714 8.074 309.699c-6.856-5.142-9.712-13.996-7.141-21.993l28.849-87.974zm75.405-174.806c-3.142-8.854-15.709-8.854-18.851.0L29.782 199.732h131.961L105.187 24.926zm56.556 174.806L256 493.714l94.257-293.982H161.743zm349.324 87.974-28.849-87.974L256 493.714l247.926-184.015c6.855-5.142 9.711-13.996 7.141-21.993zm-85.404-262.78c-3.142-8.854-15.709-8.854-18.851.0l-56.555 174.806h131.961L425.663 24.926z"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a><a href=https://github.com/rluetzner target=_blank class="github ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel=noopener aria-label="follow on GitHub——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a><a href=https://schafe-sind-bessere-rasenmaeher.de/index.xml target=_blank class="rss ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="RSS link" rel=noopener aria-label="follow on RSS——Opens in a new window"><span class=icon><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="6.18" cy="17.82" r="2.18"/><path id="scale" d="M4 4.44v2.83c7.03.0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9.0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a></div></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">TECH</aside><div id=sharing class="mt3 ananke-socials"></div><h1 class="f1 athelas mt3 mb1">I toot with the power of cURL</h1><p class=tracked>By <strong>Robert Lützner</strong></p><time class="f6 mv4 dib tracked" datetime=2022-11-01T20:56:12+01:00>1. November 2022</time>
<span class="f6 mv4 dib tracked">- 6 minutes read</span>
<span class="f6 mv4 dib tracked">- 1182 words</span></header><div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>I spent the last two days trying to make a simple script that toots a static message on Mastodon. The idea came to me, because my instance admin is determined to welcome all new users to the instance. He&rsquo;s been using the same message for a while, but when asked he admited that he puts them together manually every time.</p><p>As I&rsquo;m not familiar with administrating a Mastodon instance, I offered to help in automating the part of the process sending out a welcome toot. Here&rsquo;s my journey including the pitfalls.</p><p>You can find the working script <a href=https://codeberg.org/RollenspielMonster/rollenspiel.social/src/branch/master/simple-toot>here</a>.</p><h2 id=starting-out-ie-registering-a-new-client-application>Starting out, i.e. registering a new client application</h2><p>I asked my good friend <a href=https://startpage.com>Startpage</a> for advice and promptly crashlanded on the Mastondon API documentation. If I were a more determined person I might have stayed there (and saved myself a bit of trouble), but I&rsquo;m lazy. So I went looking further and found <a href=https://leancrew.com/all-this/2018/08/autotooting-with-mastodon/>this article from leancrew.com</a>.</p><p>I quickly scanned the article (which I found way too long to actually read) for the necessary cURL commands. The first one I found was this (adjusted to my use-case):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Register a new client application.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Works like a charm.</span>
</span></span><span style=display:flex><span>curl -X POST <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -F <span style=color:#e6db74>&#34;client_name=simple-toot&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -F <span style=color:#e6db74>&#34;redirect_uris=urn:ietf:wg:oauth:2.0:oob&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -F <span style=color:#e6db74>&#34;scopes=write&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -F <span style=color:#e6db74>&#34;website=https://rollenspiel.social&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    https://rollenspiel.social/api/v1/apps
</span></span></code></pre></div><p>The output is an easy to understand JSON that contains the desired client ID and secret values.</p><h2 id=getting-an-access-token----the-wrong-way>Getting an access token &ndash; the wrong way</h2><p>The next step in the process is to retrieve an access token from the server. Seemingly that is another simple POST request:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># WARNING! This code uses deprecated parameters.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl -X POST <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -F <span style=color:#e6db74>&#34;client_id=&lt;CLIENT-ID&gt;&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -F <span style=color:#e6db74>&#34;client_secret=&lt;CLIENT-SECRET&gt;&#34;</span> <span style=color:#ae81ff>\ </span>
</span></span><span style=display:flex><span>    -F <span style=color:#e6db74>&#34;scope=write&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -F <span style=color:#e6db74>&#34;grant_type=password&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -F <span style=color:#e6db74>&#34;username=&lt;USERNAME&gt;&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -F <span style=color:#e6db74>&#34;password=&lt;PASSWORD&gt;&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    https://rollenspiel.social/oauth/token
</span></span></code></pre></div><p>This however does not work. At this point I was confident enough (again) with cURL&rsquo;s syntax to attempt reading the <a href=https://docs.joinmastodon.org/methods/apps/oauth/#obtain-a-token>Mastodon API docs</a> directly. It was also getting pretty late and I wanted to get this done as quickly as possible, so I scanned the documentation for interesting keywords. I discovered that <code>grant_type=password</code> no longer exists and it should read <code>grant_type=client_credentials</code> instead. Or so I thought. More on that later.</p><p>I also had to add the same <code>redirect_uri</code> I used when registering the client app in the first step.</p><p>The updated request therefore looked something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># WARNING! This code will work, but it is not what we want.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Check below for the right code and an explanation why.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl -X POST <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -F <span style=color:#e6db74>&#34;client_id=&lt;CLIENT-ID&gt;&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -F <span style=color:#e6db74>&#34;client_secret=&lt;CLIENT-SECRET&gt;&#34;</span> <span style=color:#ae81ff>\ </span>
</span></span><span style=display:flex><span>    -F <span style=color:#e6db74>&#34;scope=write&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -F <span style=color:#e6db74>&#34;grant_type=client_credentials&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -F <span style=color:#e6db74>&#34;redirect_uri=urn:ietf:wg:oauth:2.0:oob&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -F <span style=color:#e6db74>&#34;username=&lt;USERNAME&gt;&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -F <span style=color:#e6db74>&#34;password=&lt;PASSWORD&gt;&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    https://rollenspiel.social/oauth/token
</span></span></code></pre></div><p>This completed successfully and returned a JSON containing the desired access token element.</p><h2 id=sending-a-toot-without-the-proper-permissions-or-why-the-f-isnt-this-working>Sending a toot without the proper permissions or WHY THE F*!= ISN&rsquo;T THIS WORKING???</h2><p>The last step, now that we have the user-specific access token for our app, is to actually toot a message. The leancrew.com article I used as a tutorial resorted to using Python here, but I wanted to keep this as simple as possible.</p><blockquote><p>I still ended up with Python in the script, because I figured it would be the safest way to parse a value from a JSON string.</p><p><code>jq</code> is also an option, but the chance that <code>python</code> is already installed is basically 100% and at least in my experience <code>jq</code> has to be installed manually at some point.</p></blockquote><p>This should work:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># This will work in the end, but not right now!</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TEXT<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;this is
</span></span></span><span style=display:flex><span><span style=color:#e6db74>a multiline
</span></span></span><span style=display:flex><span><span style=color:#e6db74>text.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>it
</span></span></span><span style=display:flex><span><span style=color:#e6db74>should
</span></span></span><span style=display:flex><span><span style=color:#e6db74>work
</span></span></span><span style=display:flex><span><span style=color:#e6db74>(hopefully).&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl -s -X POST <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -H <span style=color:#e6db74>&#34;Authorization: Bearer </span><span style=color:#e6db74>${</span>ACCESS_TOKEN<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -F <span style=color:#e6db74>&#34;status=</span><span style=color:#e6db74>${</span>TEXT<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	-F <span style=color:#e6db74>&#34;visibility=direct&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    https://rollenspiel.social/api/v1/statuses
</span></span></code></pre></div><p>This however kept returning the following error:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>HTTP Error 422: This method requires an authenticated user.
</span></span></code></pre></div><p>What the hell? I received an access token without error, why shouldn&rsquo;t it work.</p><p>I tried adding quotes to the <code>$ACCESS_TOKEN</code> variable, but then the error message stated that the access token wasn&rsquo;t valid. So the syntax and the token itself weren&rsquo;t the problem.</p><p>At this point I gave up for the day. I took all the information I had until now and put it into a <a href=https://rollenspiel.social/@mforester/109264958526719952>toot</a>.</p><h2 id=learning-to-read-again-or-getting-an-access-token----the-right-way>Learning to read (again) or getting an access token &ndash; the right way</h2><p>When I came back the next day I went straight for the Mastodon API docs again. I had gotten a few answers to my toot, but neither a solution nor an explanation.</p><p>What bugged me was that the different errors from before told me that I had a valid access token. But for whatever reason &ndash; even though I had specifically requested a &lsquo;write&rsquo; scope &ndash; the access token didn&rsquo;t have the necessary permissions to toot in my name.</p><p>After just a few minutes I found this exact piece of information in the documentation of the POST request I used earlier.</p><blockquote><p><strong>grant_type (REQUIRED)</strong> &ndash; <em>string</em> &ndash; Set equal to <code>authorization_code</code> if code is provided in order to gain user-level access. Otherwise, set equal to <code>client_credentials</code> to obtain app-level access only.</p></blockquote><p><em>User-level access</em>? Be still my heart!</p><p>As it turns out there was another step missing. A step that (at least for me) brought it all into focus.</p><p>At the very top of the <a href=https://docs.joinmastodon.org/methods/apps/oauth/#obtain-a-token>docs page</a> where I was looking was a GET request to prompt the user to authorize a given client app. That is also what I&rsquo;ve seen other apps, e.g. Tusky, do. It also gets rid of the username and password, which not only cleans up the script, but also makes it a bit safer in my opinion. If it never even knows the user&rsquo;s credentials there&rsquo;s nothing harmful it could do with them.</p><p>So the final piece of the puzzle looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>echo <span style=color:#e6db74>&#34;https://rollenspiel.social/oauth/authorize?response_type=code&amp;client_id=</span><span style=color:#e6db74>${</span>CLIENT_ID<span style=color:#e6db74>}</span><span style=color:#e6db74>&amp;redirect_uri=urn:ietf:wg:oauth:2.0:oob&amp;scope=write&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>read -p <span style=color:#e6db74>&#34;Enter the authorization code: &#34;</span> AUTH_CODE
</span></span></code></pre></div><p>The user has to open up a specific URL in their browser, log in and authorize the app to access their account. As I&rsquo;ve seen in other CLI tools (e.g. RClone) I simply prompt the user to paste the authorization code.</p><p>With this we can get <em>user-level</em> access by modifying the POST request we used earlier to receive an access token:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -s -X POST <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        -F <span style=color:#e6db74>&#34;client_id=</span><span style=color:#e6db74>${</span>CLIENT_ID<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        -F <span style=color:#e6db74>&#34;client_secret=</span><span style=color:#e6db74>${</span>CLIENT_SECRET<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        -F <span style=color:#e6db74>&#34;scope=write&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        -F <span style=color:#e6db74>&#34;grant_type=authorization_code&#34;</span><span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        -F <span style=color:#e6db74>&#34;code=</span><span style=color:#e6db74>${</span>AUTH_CODE<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        -F <span style=color:#e6db74>&#34;redirect_uri=urn:ietf:wg:oauth:2.0:oob&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        https://rollenspiel.social/oauth/token
</span></span></code></pre></div><p>Notice that the <code>username</code> and <code>password</code> are gone. We use <code>grant_type=authorization_code</code> and hand over the code the user pasted earlier.</p><p>This returns an access token that has the necessary permissions. The toot command from earlier now works without any modifications.</p><h2 id=wrap-up>Wrap-up</h2><p>The entire process goes something like this:</p><ol><li>Register a new client app with the server, i.e. receive a client id and secret.</li><li>Prompt the user to visit a URL and authorize the tool to access their account. The user has to copy and paste an authorization code.</li><li>Get an access token using the authorization code from the previous step.</li><li>Toot!</li></ol><p>Steps 1-3 are one-time only. As long as we have an access token, there&rsquo;s no reason to go through this process again.</p><p>Again, look up the final script <a href=https://codeberg.org/RollenspielMonster/rollenspiel.social/src/branch/master/simple-toot>here</a> and feel free to use it and/or send in any improvements.</p><ul class=pa0><li class="list di"><a href=/tags/mastodon class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">mastodon</a></li><li class="list di"><a href=/tags/curl class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">curl</a></li></ul><div class="mt6 instapaper_ignoref"></div></div><aside class="w-30-l mt6-l"></aside></article></main><footer class="bg-dark-gray bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://www.schafe-sind-bessere-rasenmaeher.de>&copy; Schafe sind bessere Rasenmäher 2022</a><div><div class=ananke-socials><a href=https://rollenspiel.social/@mforester target=_blank class="mastodon ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="Mastodon link" rel=me aria-label="follow on Mastodon——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 230 230" viewBox="0 0 230 230" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M211.80683 139.0875c-3.1825 16.36625-28.4925 34.2775-57.5625 37.74875-15.16 1.80875-30.0825 3.47125-45.99875 2.74125-26.0275-1.1925-46.565-6.2125-46.565-6.2125.0 2.53375.15625 4.94625.46875 7.2025 3.38375 25.68625 25.47 27.225 46.3925 27.9425 21.115.7225 39.91625-5.20625 39.91625-5.20625l.86875 19.09s-14.77 7.93125-41.08125 9.39c-14.50875.7975-32.52375-.365-53.50625-5.91875C9.23183 213.82 1.40558 165.31125.20808 116.09125c-.36375-14.61375-.14-28.39375-.14-39.91875.0-50.33 32.97625-65.0825 32.97625-65.0825C49.67058 3.45375 78.20308.2425 107.86433.0h.72875c29.66125.2425 58.21125 3.45375 74.8375 11.09.0.0 32.97625 14.7525 32.97625 65.0825.0.0.4125 37.13375-4.6 62.915" style="fill-rule:evenodd;clip-rule:evenodd"/><path d="M65.68743 96.45938c0 9.01375-7.3075 16.32125-16.3225 16.32125-9.01375.0-16.32-7.3075-16.32-16.32125.0-9.01375 7.30625-16.3225 16.32-16.3225 9.015.0 16.3225 7.30875 16.3225 16.3225M124.52893 96.45938c0 9.01375-7.30875 16.32125-16.3225 16.32125s-16.32125-7.3075-16.32125-16.32125c0-9.01375 7.3075-16.3225 16.32125-16.3225 9.01375.0 16.3225 7.30875 16.3225 16.3225M183.36933 96.45938c0 9.01375-7.3075 16.32125-16.32125 16.32125s-16.32125-7.3075-16.32125-16.32125c0-9.01375 7.3075-16.3225 16.32125-16.3225s16.32125 7.30875 16.32125 16.3225" fill="#fff"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a><a href=https://codeberg.org/rluetzner target=_blank class="codeberg ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="codeberg link" rel=noopener aria-label="follow on codeberg——Opens in a new window"><span class=icon><svg viewBox="0 0 512 512" id="svg15" sodipodi:docname="codeberg.svg" inkscape:version="1.2.1 (9c6d41e410, 2022-07-14)" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><defs id="defs19"><filter style="color-interpolation-filters:sRGB" inkscape:label="Lightness-Contrast" id="filter1778" x="0" y="0" width="1" height="1"><feColorMatrix values="0.21 0.72 0.072 0 0 0.21 0.72 0.072 0 0 0.21 0.72 0.072 0 0 0 0 0 1 0" id="feColorMatrix1776" result="fbSourceGraphic"/><feColorMatrix result="fbSourceGraphicAlpha" in="fbSourceGraphic" values="0 0 0 -1 0 0 0 0 -1 0 0 0 0 -1 0 0 0 0 1 0" id="feColorMatrix1873"/><feColorMatrix id="feColorMatrix1875" values="1 0 0 0.253601 -0 0 1 0 0.253601 -0 0 0 1 0.253601 -0 0 0 0 1 0" in="fbSourceGraphic"/></filter><filter style="color-interpolation-filters:sRGB" inkscape:label="Lightness-Contrast" id="filter1782" x="0" y="0" width="1" height="1"><feColorMatrix values="0.21 0.72 0.072 0 0 0.21 0.72 0.072 0 0 0.21 0.72 0.072 0 0 0 0 0 1 0" id="feColorMatrix1780" result="fbSourceGraphic"/><feColorMatrix result="fbSourceGraphicAlpha" in="fbSourceGraphic" values="0 0 0 -1 0 0 0 0 -1 0 0 0 0 -1 0 0 0 0 1 0" id="feColorMatrix1877"/><feColorMatrix id="feColorMatrix1879" values="1 0 0 0.253601 -0 0 1 0 0.253601 -0 0 0 1 0.253601 -0 0 0 0 1 0" in="fbSourceGraphic"/></filter><filter style="color-interpolation-filters:sRGB" inkscape:label="Greyscale" id="filter1786" x="0" y="0" width="1" height="1"><feColorMatrix values="0.21 0.72 0.072 0 0 0.21 0.72 0.072 0 0 0.21 0.72 0.072 0 0 0 0 0 1 0" id="feColorMatrix1784"/></filter></defs><sodipodi:namedview id="namedview17" pagecolor="#ffffff" bordercolor="#666666" borderopacity="1" inkscape:showpageshadow="2" inkscape:pageopacity="0" inkscape:pagecheckerboard="0" inkscape:deskcolor="#d1d1d1" showgrid="false" inkscape:zoom="1.5332031" inkscape:cx="256" inkscape:cy="204.14777" inkscape:window-width="1920" inkscape:window-height="951" inkscape:window-x="0" inkscape:window-y="32" inkscape:window-maximized="1" inkscape:current-layer="svg15"/><linearGradient id="a" gradientUnits="userSpaceOnUse" x1="259.804" x2="383.132" y1="161.4" y2="407.835"><stop offset="0" stop-color="#fff" stop-opacity="0" id="stop2"/><stop offset=".5" stop-color="#71c2ff" id="stop4"/><stop offset="1" stop-color="#39aaff" id="stop6"/></linearGradient><path d="m259.804 161.4c-.44.0-1.1.0-1.32.44l-.44 1.1 73.996 277.27a192.039 192.039.0 0086.77-74.437L261.125 162.06a1.762 1.762.0 00-1.321-.661z" fill="url(#a)" opacity=".5" id="path11" style="fill:url(#a);filter:url(#filter1782)" transform="matrix(1.3242691,0,0,1.3242691,-82.717006,-82.736123)"/><path d="m255.3 71.8a192 192 0 00-162 294l160.1-207c.5-.6 1.5-1 2.6-1s2 .4 2.6 1l160 207a192 192 0 0029.4-102c0-106-86-192-192-192a192 192 0 00-.7.0z" fill="#2185d0" id="path13" style="filter:url(#filter1778)" transform="matrix(1.3242691,0,0,1.3242691,-82.717006,-82.736123)"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a><a href=https://gitlab.com/rluetzner target=_blank class="gitlab ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="GitLab link" rel=noopener aria-label="follow on GitLab——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M29.782 199.732 256 493.714 8.074 309.699c-6.856-5.142-9.712-13.996-7.141-21.993l28.849-87.974zm75.405-174.806c-3.142-8.854-15.709-8.854-18.851.0L29.782 199.732h131.961L105.187 24.926zm56.556 174.806L256 493.714l94.257-293.982H161.743zm349.324 87.974-28.849-87.974L256 493.714l247.926-184.015c6.855-5.142 9.711-13.996 7.141-21.993zm-85.404-262.78c-3.142-8.854-15.709-8.854-18.851.0l-56.555 174.806h131.961L425.663 24.926z"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a><a href=https://github.com/rluetzner target=_blank class="github ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel=noopener aria-label="follow on GitHub——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a><a href=https://schafe-sind-bessere-rasenmaeher.de/index.xml target=_blank class="rss ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="RSS link" rel=noopener aria-label="follow on RSS——Opens in a new window"><span class=icon><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="6.18" cy="17.82" r="2.18"/><path id="scale" d="M4 4.44v2.83c7.03.0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9.0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a></div></div></div></footer></body></html>